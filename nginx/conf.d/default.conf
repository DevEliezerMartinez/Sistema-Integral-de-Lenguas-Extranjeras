server {
    listen 80;
    server_name localhost;

    # Frontend (React)
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Backend (Laravel Sanctum - MUST come before /api)
    location /sanctum {
        fastcgi_pass backend:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param QUERY_STRING $query_string;
    }

    # Backend (Laravel API)
    location /api {
        fastcgi_pass backend:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param QUERY_STRING $query_string;
    }
    
    # Also handle storage links if necessary, but usually API returns URLs.
    # If API returns URLs like http://localhost:8000/storage/..., we need to handle /storage
    location /storage {
        # We need to proxy this to the backend as well, OR share the volume.
        # Since we want to avoid shared volumes for code, but STORAGE is data.
        # So we SHOULD share the storage volume.
        alias /var/www/html/storage/app/public;
    }
}
